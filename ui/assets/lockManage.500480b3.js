var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(t,s,o)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o;"undefined"!=typeof require&&require;import{A as a}from"./api_dbManage.c76fae4d.js";import{D as n}from"./DynamicRefresh.77f7f754.js";import{n as r}from"./index.e4a37cdc.js";import"./index.dfdb83b1.js";import"./vendor.194c4086.js";import"./bus.d56574c1.js";const l={};var c=r({name:"LockManage",data:()=>({needToFirstPage:!1,sortRule:{prop:null,order:null},tabData:"",loading:!1,total:0,page:1,size:20,oldpage:1,selectValue:"",isLockLoad:!1,noData:{},dbHostMsg:{},dbListForLoop:{},sessionRows:[],isShowComponents:!1,isDynamicRefresh:!1,timerList:[]}),components:{DynamicRefresh:n},watch:{selectValue:function(e){const t=this;let s={};for(let o=0;o<t.dbListForLoop.length;o++)e==t.dbListForLoop[o].db_id&&(s=t.dbListForLoop[o]);t.isLockLoad?(t.needToFirstPage=!0,t.getDBListFn(s)):t.isLockLoad=!0,this.clearTimer()}},mounted(){void 0!==this.$route.query.data&&void 0!==this.$route.query.data.db_id?this.getDBListFn(this.$route.query.data):this.getDBListFn()},methods:{switchDynamicRefreshDialog(){this.isShowComponents=!0},onDynamicRefresh(e){let{refresh_interval:t,keep_time:s}=e;this.isDynamicRefresh=!0;const o=setInterval((()=>{this.getSessionList()}),t);this.timerList.push(o);const i=setTimeout((()=>{this.clearTimer()}),s);this.timerList.push(i)},offDynamicRefresh(){this.clearTimer()},clearTimer(){this.isDynamicRefresh=!1,this.timerList.length&&(this.timerList.forEach((e=>{clearInterval(e)})),this.timerList=[])},sortChange(e){const t=this;if(null!=e.order){var s=[];for(let o=0;o<t.sessionRows.length;o++)null===t.sessionRows[o][e.prop]?s.push(t.sessionRows[o]):s.unshift(t.sessionRows[o]);t.sessionRows=s}null==e.order&&(t.sessionRows,t.tabData),t.$nextTick((()=>{t.$emit("btnHidden")})),t.sortChange.order=e.order,t.sortChange.prop=e.prop},tableRowClassName:({row:e,rowIndex:t})=>t%2!=0?"warning-row":"success-row",handleSizeChange(e){this.size=e,this.oldpage=this.page,this.needToFirstPage=!0,this.getSessionList()},handleCurrentChange(e){this.page=e,this.oldpage=this.page,this.getSessionList()},copy(e){this.$message({message:this.$t("SessionManage.yichenggong-fuzhi-message"),type:"success"})},onError(e){this.$message.error(this.$t("SessionManage.fuzhi-dao-jianqie-message"))},getDBListFn(e){const t=this;t.loading=!0,t.sessionRows=[],a.getInstanceList().then((function(s){t.loading=!1;let o={};t.dbListForLoop=s.rows,t.dbListForLoop.unshift({db_state:0,db_id:!1}),void 0===e?(o=t.dbListForLoop.find((e=>!1===e.db_id)),t.dbHostMsg=o,t.selectValue=t.dbHostMsg.db_id):(t.selectValue=e.db_id,t.dbHostMsg=e),t.getSessionList()}))},getSessionList(){const e=this;e.needToFirstPage&&(e.page=1),1==e.page&&(e.total=0);const n=((e,a)=>{for(var n in a||(a={}))s.call(a,n)&&i(e,n,a[n]);if(t)for(var n of t(a))o.call(a,n)&&i(e,n,a[n]);return e})({page_num:e.page,page_size:e.size},!1!==e.dbHostMsg.db_id&&{db_id:e.dbHostMsg.db_id});e.loading=!0,a.getDbLockInfo(n).then((function(t){e.loading=!1,e.needToFirstPage=!1,e.sessionRows=t.rows,e.tabData=t.rows,null!=e.sortRule.order&&e.sortChange(e.sortRule),e.total=t.total,e.$refs.pagination,e.$nextTick((()=>{e.$emit("btnHidden")}))}),(function(t){e.loading=!1}))},terminationLock(e){let t=this;this.$confirm(this.$t("lockManage.queren-zhongzhi")+e.blocking_pid+this.$t("lockManage.ma"),this.$t("index.ti-shi"),{type:"warning",closeOnClickModal:!1}).then((()=>{t.loading=!0;let s={db_id:t.dbHostMsg.db_id,pid:e.blocking_pid};a.terminateBackend(s).then((function(){t.loading=!1,t.getSessionList()}),(function(e){t.loading=!1}))})).catch((()=>{}))}},beforeDestroy(){this.clearTimer()}},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("el-row",{staticClass:"warp"},[s("el-form",[s("el-form-item",[s("el-select",{staticStyle:{width:"170px"},attrs:{filterable:"",placeholder:e.$t("createDatabasePage.qing-xuan-ze")},model:{value:e.selectValue,callback:function(t){e.selectValue=t},expression:"selectValue"}},e._l(e.dbListForLoop,(function(t,o){return s("el-option",{key:o,attrs:{label:t.db_id?t.host+":"+t.port:"csumdb",value:t.db_id}},[t.db_id?s("el-tooltip",{staticClass:"item",attrs:{"open-delay":1e3,effect:"dark",content:t.host+":"+t.port,placement:"top"}},[t.db_id?s("span",[e._v(" "+e._s(t.host+":"+t.port))]):e._e()]):s("span",[e._v(" csumdb ")])],1)})),1),s("div",{staticStyle:{float:"right"}},[s("el-button",{staticClass:"normal el-icon-refresh-right",on:{click:e.getSessionList}},[e._v(" "+e._s(e.$t("resourceManagement.shua-xin")))]),e.isDynamicRefresh?s("el-button",{attrs:{type:"warning"},on:{click:e.offDynamicRefresh}},[e._v(" "+e._s(e.$t("SessionManage.gaunbi-dongtai-shuaxin"))+" ")]):s("el-button",{attrs:{type:"primary"},on:{click:e.switchDynamicRefreshDialog}},[e._v(" "+e._s(e.$t("SessionManage.kaiqi-dongtai-shuaxin"))+" ")])],1)],1)],1),s("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{"default-sort":e.sortRule,"row-class-name":e.tableRowClassName,data:e.sessionRows,border:"","element-loading-text":"正在加载中..."},on:{"sort-change":e.sortChange}},[s("el-table-column",{attrs:{prop:"blocking_pid",label:e.$t("lockManage.zuse-pid"),align:"center",width:"90px",fixed:""}}),s("el-table-column",{attrs:{prop:"blocking_user",sortable:"",label:e.$t("lockManage.zuse-yonghu"),align:"center","min-width":"100px","show-overflow-tooltip":""}}),s("el-table-column",{attrs:{prop:"blocking_query",label:e.$t("lockManage.zuse-sql"),align:"center","min-width":"200px","show-overflow-tooltip":""}}),s("el-table-column",{attrs:{prop:"blocked_pid",label:e.$t("lockManage.beizuse-pid"),align:"center"}}),s("el-table-column",{attrs:{prop:"blocked_user","min-width":"120px",sortable:"",label:e.$t("lockManage.beizuse-yonghu"),align:"center","show-overflow-tooltip":""}}),s("el-table-column",{attrs:{prop:"query",label:e.$t("lockManage.beizuse-sql"),align:"center","min-width":"200px","show-overflow-tooltip":""}}),s("el-table-column",{attrs:{prop:"age",sortable:"",label:e.$t("lockManage.beizuse-shijian"),align:"center",width:"120px","show-overflow-tooltip":""}}),s("el-table-column",{attrs:{prop:"detail",label:e.$t("dbList.cao-zuo"),align:"center",width:"120px",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(t){return[s("el-link",{staticClass:"kill",on:{click:function(s){return e.terminationLock(t.row)}}},[e._v(e._s(e.$t("lockManage.zhongzhisuo")))])]}}])})],1),s("div",{staticClass:"block",staticStyle:{float:"right"}},[s("el-pagination",{ref:"pagination",attrs:{layout:"total, sizes, prev, pager, next, jumper",total:e.total,"page-sizes":[20,30,40,50,100]},on:{"size-change":e.handleSizeChange,"current-change":e.handleCurrentChange}})],1),e.isShowComponents?s("DynamicRefresh",{attrs:{"is-show":e.isShowComponents},on:{confirm:e.onDynamicRefresh,"update:isShow":function(t){e.isShowComponents=t},"update:is-show":function(t){e.isShowComponents=t}}}):e._e()],1)}),[],!1,d,"601caa15",null,null);function d(e){for(let t in l)this[t]=l[t]}var h=function(){return c.exports}();export{h as default};
